generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_CONNECTION_URI")
}

enum InstanceConnectionStatus {
  open
  close
  connecting
}

enum DeviceMessage {
  ios
  android
  web
  unknown
  desktop
}

enum SessionStatus {
  opened
  closed
  paused
}

enum TriggerType {
  all
  keyword
  none
  advanced
}

enum TriggerOperator {
  contains
  equals
  startsWith
  endsWith
  regex
}

enum OpenaiBotType {
  assistant
  chatCompletion
}

enum DifyBotType {
  chatBot
  textGenerator
  agent
  workflow
}

model Instance {
  id                      String                   @id @default(cuid())
  name                    String                   @unique @db.VarChar(255)
  connectionStatus        InstanceConnectionStatus @default(open)
  ownerJid                String?                  @db.VarChar(100)
  profileName             String?                  @db.VarChar(100)
  profilePicUrl           String?                  @db.VarChar(500)
  integration             String?                  @db.VarChar(100)
  number                  String?                  @db.VarChar(100)
  businessId              String?                  @db.VarChar(100)
  token                   String?                  @db.VarChar(255)
  clientName              String?                  @db.VarChar(100)
  disconnectionReasonCode Int?                     @db.Int
  disconnectionObject     Json?                    @db.Json
  disconnectionAt         DateTime?                @db.Timestamp
  createdAt               DateTime?                @default(dbgenerated("CURRENT_TIMESTAMP")) @db.Timestamp
  updatedAt               DateTime?                @updatedAt @db.Timestamp

  // Relações
  Chat                    Chat[]
  Contact                 Contact[]
  Message                 Message[]
  Webhook                 Webhook?
  Chatwoot                Chatwoot?
  Label                   Label[]
  Proxy                   Proxy?
  Setting                 Setting?
  Rabbitmq                Rabbitmq?
  Nats                    Nats?
  Sqs                     Sqs?
  Kafka                   Kafka?
  Websocket               Websocket?
  Typebot                 Typebot[]
  Session                 Session?
  MessageUpdate           MessageUpdate[]
  TypebotSetting          TypebotSetting[]
  Media                   Media[]
  OpenaiCreds             OpenaiCreds[]
  OpenaiBot               OpenaiBot[]
  OpenaiSetting           OpenaiSetting[]
  Template                Template[]
  Dify                    Dify[]
  DifySetting             DifySetting[]
  IntegrationSession      IntegrationSession[]
  EvolutionBot            EvolutionBot[]
  EvolutionBotSetting     EvolutionBotSetting[]
  Flowise                 Flowise[]
  FlowiseSetting          FlowiseSetting[]
  N8n                     N8n[]
  N8nSetting              N8nSetting[]
  Evoai                   Evoai[]
  EvoaiSetting            EvoaiSetting[]
  Pusher                  Pusher?
}

// ---------- MODELS BÁSICOS DE EXEMPLO ----------
model Chat {
  id         String   @id @default(cuid())
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model Contact {
  id         String   @id @default(cuid())
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model Message {
  id         String   @id @default(cuid())
  body       String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model Webhook {
  id         String   @id @default(cuid())
  url        String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model Chatwoot {
  id         String   @id @default(cuid())
  token      String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model Label {
  id         String   @id @default(cuid())
  name       String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model Proxy {
  id         String   @id @default(cuid())
  url        String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model Setting {
  id         String   @id @default(cuid())
  key        String
  value      String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model Rabbitmq {
  id         String   @id @default(cuid())
  config     Json
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model Nats {
  id         String   @id @default(cuid())
  config     Json
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model Sqs {
  id         String   @id @default(cuid())
  config     Json
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model Kafka {
  id         String   @id @default(cuid())
  config     Json
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model Websocket {
  id         String   @id @default(cuid())
  url        String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model MessageUpdate {
  id         String   @id @default(cuid())
  messageId  String
  newBody    String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model OpenaiCreds {
  id         String   @id @default(cuid())
  apiKey     String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  OpenaiSetting OpenaiSetting[]
}

model Template {
  id         String   @id @default(cuid())
  content    String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model IntegrationSession {
  id         String   @id @default(cuid())
  sessionId  String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

// ---------- SESSIONS E SETTINGS DE BOTS ----------
model Session {
  id        String   @id @default(cuid())
  sessionId String   @unique
  creds     String?  @db.Text
  createdAt DateTime @default(dbgenerated("CURRENT_TIMESTAMP")) @db.Timestamp
  Instance  Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId String   @unique
}

model TypebotSetting {
  id                String    @id @default(cuid())
  expire            Int?      @default(0) @db.Int
  keywordFinish     String?   @db.VarChar(100)
  delayMessage      Int?      @db.Int
  unknownMessage    String?   @db.VarChar(100)
  listeningFromMe   Boolean?  @default(false)
  stopBotFromMe     Boolean?  @default(false)
  keepOpen          Boolean?  @default(false)
  debounceTime      Int?      @db.Int
  typebotIdFallback String?   @db.VarChar(100)
  ignoreJids        Json?
  createdAt         DateTime? @default(dbgenerated("CURRENT_TIMESTAMP")) @db.Timestamp
  updatedAt         DateTime  @updatedAt @db.Timestamp
  Fallback          Typebot?  @relation(fields: [typebotIdFallback], references: [id], onDelete: SetNull)
  Instance          Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId        String
}

model OpenaiSetting {
  id               String       @id @default(cuid())
  expire           Int?         @default(0) @db.Int
  keywordFinish    String?      @db.VarChar(100)
  delayMessage     Int?         @db.Int
  unknownMessage   String?      @db.VarChar(100)
  listeningFromMe  Boolean?     @default(false)
  stopBotFromMe    Boolean?     @default(false)
  keepOpen         Boolean?     @default(false)
  debounceTime     Int?         @db.Int
  ignoreJids       Json?
  splitMessages    Boolean?     @default(false)
  timePerChar      Int?         @default(50) @db.Int
  createdAt        DateTime?    @default(dbgenerated("CURRENT_TIMESTAMP")) @db.Timestamp
  updatedAt        DateTime     @updatedAt @db.Timestamp
  OpenaiCreds      OpenaiCreds? @relation(fields: [openaiCredsId], references: [id])
  openaiCredsId    String
  Fallback         OpenaiBot?   @relation(fields: [openaiIdFallback], references: [id], onDelete: SetNull)
  openaiIdFallback String?      @db.VarChar(100)
  Instance         Instance     @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId       String
}

// ---------- MODELS DE BOT MÍNIMOS (EXEMPLO) ----------
model Typebot {
  id         String @id @default(cuid())
  name       String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  TypebotSetting TypebotSetting[]
  FallbackFrom TypebotSetting[] @relation("TypebotFallback")
}

model OpenaiBot {
  id         String @id @default(cuid())
  name       String
  instanceId String @unique
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  OpenaiSettingFallback OpenaiSetting[] @relation("OpenaiFallback")
}

// ---------------------- MODELS MÍNIMOS PARA FUNCIONAR ----------------------
model Media {
  id         String   @id @default(cuid())
  url        String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model Dify {
  id         String   @id @default(cuid())
  name       String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model DifySetting {
  id         String   @id @default(cuid())
  key        String
  value      String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model EvolutionBot {
  id         String   @id @default(cuid())
  name       String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model EvolutionBotSetting {
  id         String   @id @default(cuid())
  key        String
  value      String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model Flowise {
  id         String   @id @default(cuid())
  name       String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model FlowiseSetting {
  id         String   @id @default(cuid())
  key        String
  value      String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model N8n {
  id         String   @id @default(cuid())
  name       String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model N8nSetting {
  id         String   @id @default(cuid())
  key        String
  value      String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model Evoai {
  id         String   @id @default(cuid())
  name       String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model EvoaiSetting {
  id         String   @id @default(cuid())
  key        String
  value      String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model Pusher {
  id         String   @id @default(cuid())
  key        String
  cluster    String
  instanceId String @unique
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}
