generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_CONNECTION_URI")
}

enum InstanceConnectionStatus {
  open
  close
  connecting
}

model Instance {
  id            String                   @id @default(cuid())
  name          String                   @unique
  connectionStatus InstanceConnectionStatus @default(open)
  createdAt     DateTime                 @default(dbgenerated("CURRENT_TIMESTAMP"))
  updatedAt     DateTime                 @updatedAt

  // Relações
  Chats         Chat[]
  Contacts      Contact[]
  Messages      Message[]
  Webhook       Webhook?                 @relation(fields: [webhookId], references: [id])
  webhookId     String?                  @unique
  Chatwoot      Chatwoot?                @relation(fields: [chatwootId], references: [id])
  chatwootId    String?                  @unique
  Labels        Label[]
  Proxy         Proxy?                   @relation(fields: [proxyId], references: [id])
  proxyId       String?                  @unique
  Setting       Setting?                 @relation(fields: [settingId], references: [id])
  settingId     String?                  @unique
  Typebots      Typebot[]
  Sessions      Session?                 @relation(fields: [sessionId], references: [id])
  sessionId     String?                  @unique
  Media         Media[]
  OpenaiBots    OpenaiBot[]
  OpenaiSettings OpenaiSetting[]
  OpenaiCreds   OpenaiCreds[]
}

model Chat {
  id         String   @id @default(cuid())
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model Contact {
  id         String   @id @default(cuid())
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model Message {
  id         String   @id @default(cuid())
  body       String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model Webhook {
  id         String   @id @default(cuid())
  url        String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id])
}

model Chatwoot {
  id         String   @id @default(cuid())
  token      String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id])
}

model Label {
  id         String   @id @default(cuid())
  name       String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id])
}

model Proxy {
  id         String   @id @default(cuid())
  url        String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id])
}

model Setting {
  id         String   @id @default(cuid())
  key        String
  value      String
  instanceId String
  Instance   Instance @relation(fields: [instanceId], references: [id])
}

model Session {
  id         String   @id @default(cuid())
  sessionId  String   @unique
  creds      String?
  instanceId String   @unique
  Instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

// ---------- OpenaiCreds e OpenaiSetting com relação bidirecional ----------
model OpenaiCreds {
  id               String        @id @default(cuid())
  apiKey           String
  instanceId       String
  Instance         Instance      @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  OpenaiSetting    OpenaiSetting?
}

model OpenaiSetting {
  id               String        @id @default(cuid())
  instanceId       String
  Instance         Instance      @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  openaiCredsId    String?       @unique
  OpenaiCreds      OpenaiCreds?  @relation(fields: [openaiCredsId], references: [id])
}

// ---------- Typebot e TypebotSetting com relação bidirecional ----------
model Typebot {
  id                String            @id @default(cuid())
  name              String
  instanceId        String
  Instance          Instance          @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  TypebotSettings   TypebotSetting[]
}

model TypebotSetting {
  id             String     @id @default(cuid())
  typebotId      String
  typebot        Typebot    @relation(fields: [typebotId], references: [id])
  instanceId     String
  Instance       Instance   @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

